<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>LogMeow</title>
        <script>
            let setting = require('../settingsModule.js')
            let adb = require('../adbModule.js')
            let log = require('../logModule.js')
            let ui = require('./uiModule.js')
            //let tabDrag = require('./uiTabDragModule.js')

            async function updateDeviceList() {
                ui.updateDeviceList(await adb.getDevices())
            }

            function addLog(logEntry) {
                let addResult = log.addLog(logEntry)
                ui.addLogLine(logEntry)
                ui.scrollToBottom()
                if (addResult.isExceed) {
                    ui.removeTopLogLine()
                }
                if (!addResult.isFilterSatisfied) {
                    ui.setVisibilityLogLine(logEntry.logIndex, false)
                }
            }

            function clickLoggingButton() {
                let state = ui.toggleLoggingState()
                if (state === true) {
                    let deviceList = document.querySelector('#deviceList')
                    let serial = deviceList.options[deviceList.selectedIndex].value
                    console.log('Start Log : ' + serial)
                    adb.startLogcat(serial, addLog)
                } else {
                    console.log('Stop Log')
                    adb.stopLogcat()
                }
            }

            function openSetting() {
                setting.openSettingDirectory()
            }

            function onCreate() {
                setting.init()
                //tabDrag.initTabDrag(document)
                log.init(setting.getSetting())
                ui.init(setting.getSetting())
                adb.trackDevices(updateDeviceList)

                log.setLogBufferStatusCallback(ui.updateLogBufferStatus)

                document.querySelector("#pidFilter").addEventListener('input', function() {
                    log.updatePidFilter(this.value, ui.setVisibilityLogLine)
                });

                document.querySelector("#tagFilter").addEventListener('input', function() {
                    log.updateTagFilter(this.value, ui.setVisibilityLogLine)
                });

                document.querySelector("#messageFilter").addEventListener('input', function() {
                    log.updateMessageFilter(this.value, ui.setVisibilityLogLine)
                });


                //TODO
                /*
                document.addEventListener('copy', (event) => {
                    console.log('copy action initiated')
                });*/
            }

            function clearAll() {
                log.removeAllLog()
                ui.removeAllLogLine()
            }

            function openScheme() {
                let deviceList = document.querySelector('#deviceList')
                let serial = deviceList.options[deviceList.selectedIndex].value

                //TODO : serial이 없을 땐 경고 팝업을 대신 띄워야 한다.
                ui.openScheme(serial)
            }

            function updateLevelFilter() {
                let levelFilter = document.querySelector('#levelFilter')
                log.updateLevelFilter(levelFilter.options[levelFilter.selectedIndex].value, ui.setVisibilityLogLine)
            }
        </script>
    </head>
    <body onload="onCreate()">
        <!--header 1 line -->
        <headerline>
            <headertext>Device List</headertext>
            <img id="syncButton" class="c_header_image_button" src="sync-outline.svg" alt="Sync Devices" onclick="updateDeviceList()">
            <select id="deviceList" style="width: 300px;">
            </select>
            <img id="loggingButton" class="c_header_image_button" src="play.svg" alt="Play" onclick="clickLoggingButton()">
            <div id="logClearButton" class="c_header_image_button" alt="Wrap Text" onclick="clearAll()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <g data-name="Layer 2">
                        <g data-name="trash">
                            <rect width="24" height="24" opacity="0"/>
                            <path d="M21 6h-5V4.33A2.42 2.42 0 0 0 13.5 2h-3A2.42 2.42 0 0 0 8 4.33V6H3a1 1 0 0 0 0 2h1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8h1a1 1 0 0 0 0-2zM10 4.33c0-.16.21-.33.5-.33h3c.29 0 .5.17.5.33V6h-4zM18 19a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V8h12z" transform="scale(0.7, 0.7) translate(5, 5)"/>
                        </g>
                    </g>
                </svg>
            </div>
            <splitbar_large></splitbar_large>
            <div id="schemeButton" class="c_header_image_button" alt="Scheme" onclick="openScheme()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <g data-name="Layer 2">
                        <g data-name="compass">
                            <rect width="24" height="24" opacity="0"/>
                            <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z" transform="scale(0.7, 0.7) translate(5, 5)"/>
                            <path d="M15.68 8.32a1 1 0 0 0-1.1-.25l-4.21 1.7a1 1 0 0 0-.55.55l-1.75 4.26a1 1 0 0 0 .18 1h.05A1 1 0 0 0 9 16a1 1 0 0 0 .38-.07l4.21-1.7a1 1 0 0 0 .55-.55l1.75-4.26a1 1 0 0 0-.21-1.1zm-4.88 4.89l.71-1.74 1.69-.68-.71 1.74z" transform="scale(0.7, 0.7) translate(5, 5)"/>
                        </g>
                    </g>
                </svg>
            </div>

            <!-- header 1 right side -->
            <div style="flex-grow: 1;">
                <div style="float: right">
                    <div id="settingButton" class="c_header_image_button" alt="Setting" onclick="openSetting()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <g data-name="Layer 2">
                                <g data-name="settings">
                                    <rect width="24" height="24" opacity="0"/>
                                    <path d="M8.61 22a2.25 2.25 0 0 1-1.35-.46L5.19 20a2.37 2.37 0 0 1-.49-3.22 2.06 2.06 0 0 0 .23-1.86l-.06-.16a1.83 1.83 0 0 0-1.12-1.22h-.16a2.34 2.34 0 0 1-1.48-2.94L2.93 8a2.18 2.18 0 0 1 1.12-1.41 2.14 2.14 0 0 1 1.68-.12 1.93 1.93 0 0 0 1.78-.29l.13-.1a1.94 1.94 0 0 0 .73-1.51v-.24A2.32 2.32 0 0 1 10.66 2h2.55a2.26 2.26 0 0 1 1.6.67 2.37 2.37 0 0 1 .68 1.68v.28a1.76 1.76 0 0 0 .69 1.43l.11.08a1.74 1.74 0 0 0 1.59.26l.34-.11A2.26 2.26 0 0 1 21.1 7.8l.79 2.52a2.36 2.36 0 0 1-1.46 2.93l-.2.07A1.89 1.89 0 0 0 19 14.6a2 2 0 0 0 .25 1.65l.26.38a2.38 2.38 0 0 1-.5 3.23L17 21.41a2.24 2.24 0 0 1-3.22-.53l-.12-.17a1.75 1.75 0 0 0-1.5-.78 1.8 1.8 0 0 0-1.43.77l-.23.33A2.25 2.25 0 0 1 9 22a2 2 0 0 1-.39 0zM4.4 11.62a3.83 3.83 0 0 1 2.38 2.5v.12a4 4 0 0 1-.46 3.62.38.38 0 0 0 0 .51L8.47 20a.25.25 0 0 0 .37-.07l.23-.33a3.77 3.77 0 0 1 6.2 0l.12.18a.3.3 0 0 0 .18.12.25.25 0 0 0 .19-.05l2.06-1.56a.36.36 0 0 0 .07-.49l-.26-.38A4 4 0 0 1 17.1 14a3.92 3.92 0 0 1 2.49-2.61l.2-.07a.34.34 0 0 0 .19-.44l-.78-2.49a.35.35 0 0 0-.2-.19.21.21 0 0 0-.19 0l-.34.11a3.74 3.74 0 0 1-3.43-.57L15 7.65a3.76 3.76 0 0 1-1.49-3v-.31a.37.37 0 0 0-.1-.26.31.31 0 0 0-.21-.08h-2.54a.31.31 0 0 0-.29.33v.25a3.9 3.9 0 0 1-1.52 3.09l-.13.1a3.91 3.91 0 0 1-3.63.59.22.22 0 0 0-.14 0 .28.28 0 0 0-.12.15L4 11.12a.36.36 0 0 0 .22.45z" data-name="&lt;Group&gt;" transform="scale(0.7, 0.7) translate(5, 5)"/>
                                    <path d="M12 15.5a3.5 3.5 0 1 1 3.5-3.5 3.5 3.5 0 0 1-3.5 3.5zm0-5a1.5 1.5 0 1 0 1.5 1.5 1.5 1.5 0 0 0-1.5-1.5z" transform="scale(0.7, 0.7) translate(5, 5)"/>
                                </g>
                            </g>
                        </svg>
                    </div>
                </div>
            </div>
        </headerline>

        <!--header 2 line : Filter Tab -->
        <headerline>
            <headertext>Level Filter</headertext>
            <select id="levelFilter" style="width: 150px;" onchange="updateLevelFilter()">
            </select>
            <headertext>Pid Filter</headertext>
            <input id="pidFilter" style="width: 100px;"/>
            <headertext>Tag Filter</headertext>
            <input id="tagFilter" style="width: 150px;"/>
            <headertext>Message Filter</headertext>
            <input id="messageFilter" style="flex-grow: 1;"/>
        </headerline>

        <!-- header 3 line -->
        <!--<headerline>
            <button type="button" style="width:100px;" onclick="clearAll()">Remove All</button>
        </headerline>-->

        <!-- log tab -->
        <!--
        <logheaderline>
            <logtab class="logtab_date logtab_title" id="tabDate">Date</logtab>
            <logtabbar id="barDate"></logtabbar>
            <logtab class="logtab_pid logtab_title" id="tabPID">PID</logtab>
            <logtabbar id="barPID"></logtabbar>
            <logtab class="logtab_tid logtab_title" id="tabTID">TID</logtab>
            <logtabbar id="barTID"></logtabbar>
            <logtab class="logtab_level logtab_title" id="tabLevel">Lv</logtab>
            <logtabbar id="barLevel"></logtabbar>
            <logtab class="logtab_tag logtab_title" id="tabTag">Tag</logtab>
            <logtabbar id="barTag"></logtabbar>
            <logtab class="logtab_log logtab_title">Log</logtab>
        </logheaderline>-->

        <!--log list -->
        <logbox id="loglist"></logbox>

        <!--Footer Menu -->
        <footer>
            <div id="logScrollToBottom" class="c_footer_image_button" alt="Scroll To Bottom" onclick="ui.toggleScrollToBottom()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <g data-name="Layer 2">
                        <g data-name="download">
                            <path d="M12 15a1 1 0 0 1-.58-.18l-4-2.82a1 1 0 0 1-.24-1.39 1 1 0 0 1 1.4-.24L12 12.76l3.4-2.56a1 1 0 0 1 1.2 1.6l-4 3a1 1 0 0 1-.6.2z" transform="scale(0.7, 0.7) translate(5, 5)"/>
                            <path d="M12 13a1 1 0 0 1-1-1V4a1 1 0 0 1 2 0v8a1 1 0 0 1-1 1z" transform="scale(0.7, 0.7) translate(5, 5)"/>
                            <path d="M19 20H5a1 1 0 0 0 0 2h14a1 1 0 0 0 0-2z" transform="scale(0.7, 0.7) translate(5, 5)"/>
                            <path d="M19 20H5a1 1 0 0 0 0 2h14a1 1 0 0 0 0-2z" transform="scale(0.7, 0.7) translate(5, 1.5)"/>
                        </g>
                    </g>
                </svg>
            </div>
            <div id="logWrapTextButton" class="c_footer_image_button" alt="Wrap Text" onclick="ui.toggleLogWrapText()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M0 0h24v24H0V0z" fill="none"/>
                    <path d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3 3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z" transform="scale(0.7, 0.7) translate(5, 5)"/>
                </svg>
            </div>
            <splitbar_small></splitbar_small>
            
            <div class="c_footer_rightside">
                <footertext id="footerStatus" style="width: 200px"></footertext>
                <splitbar_small></splitbar_small>
                <footertext id="footerDetail" class="c_footer_detail"></footertext>
            </div>
        </footer>
    </body>
</html>
